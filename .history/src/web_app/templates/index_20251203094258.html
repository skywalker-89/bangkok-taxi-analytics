<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Bangkok Taxi Route Optimizer</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
          Arial;
      }

      .container {
        display: flex;
        height: 100%;
      }

      #sidebar {
        width: 400px;
        background: #f8f9fa;
        border-right: 1px solid #ddd;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      #map-container {
        flex: 1;
        position: relative;
      }

      #map {
        height: 100%;
        width: 100%;
      }

      .section {
        padding: 20px;
        border-bottom: 1px solid #ddd;
      }

      .section-title {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 15px;
        color: #333;
      }

      .input-group {
        margin-bottom: 15px;
      }

      .input-group label {
        display: block;
        font-size: 13px;
        font-weight: 500;
        margin-bottom: 5px;
        color: #555;
      }

      .input-group input,
      .input-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .input-group small {
        display: block;
        margin-top: 4px;
        color: #666;
        font-size: 12px;
      }

      .location-input {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .btn {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-primary:hover {
        background: #0056b3;
      }

      .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
        margin-top: 8px;
      }

      .btn-secondary:hover {
        background: #545b62;
      }

      .mode-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
      }

      .mode-tab {
        flex: 1;
        padding: 8px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        text-align: center;
        font-size: 13px;
        transition: all 0.2s;
      }

      .mode-tab.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        flex-direction: column;
      }

      .loading-overlay.active {
        display: flex;
      }

      .loading-content {
        text-align: center;
        max-width: 400px;
        padding: 30px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      }

      .spinner {
        width: 60px;
        height: 60px;
        border: 5px solid #f3f3f3;
        border-top: 5px solid #007bff;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading-text {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 10px;
      }

      .loading-progress {
        font-size: 14px;
        color: #666;
        margin-top: 8px;
      }

      .progress-bar-container {
        width: 100%;
        height: 6px;
        background: #e9ecef;
        border-radius: 3px;
        margin-top: 15px;
        overflow: hidden;
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #28a745);
        transition: width 0.3s ease;
        border-radius: 3px;
      }

      .results-section {
        flex: 1;
        overflow-y: auto;
      }

      .route-card {
        background: white;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 12px;
        cursor: pointer;
        transition: all 0.2s;
      }

      .route-card:hover {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .route-card.active {
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.2);
      }

      .route-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .route-rank {
        font-size: 20px;
        font-weight: 700;
        color: #007bff;
      }

      .route-revenue {
        font-size: 22px;
        font-weight: 700;
        color: #28a745;
      }

      .route-stats {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-bottom: 10px;
      }

      .stat {
        font-size: 12px;
      }

      .stat-label {
        color: #666;
        display: block;
      }

      .stat-value {
        font-weight: 600;
        color: #333;
        font-size: 14px;
      }

      .route-color-bar {
        height: 4px;
        border-radius: 2px;
        margin-top: 10px;
      }

      .trip-list {
        margin-top: 12px;
        padding-top: 12px;
        border-top: 1px solid #eee;
        display: none;
      }

      .route-card.expanded .trip-list {
        display: block;
      }

      .trip-item {
        font-size: 12px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 6px;
      }

      .legend {
        position: absolute;
        bottom: 12px;
        left: 12px;
        background: white;
        padding: 12px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 500;
        font-size: 12px;
      }

      .legend-item {
        margin-bottom: 6px;
      }

      .swatch {
        display: inline-block;
        width: 12px;
        height: 12px;
        margin-right: 6px;
        vertical-align: middle;
        border: 1px solid #999;
      }

      .marker-instructions {
        position: absolute;
        top: 12px;
        left: 50%;
        transform: translateX(-50%);
        background: #fff3cd;
        padding: 10px 16px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 500;
        font-size: 13px;
        display: none;
      }

      .marker-instructions.active {
        display: block;
      }

      .no-results {
        text-align: center;
        padding: 40px 20px;
        color: #666;
      }

      .error-message {
        background: #f8d7da;
        color: #721c24;
        padding: 12px;
        border-radius: 4px;
        margin-top: 10px;
        font-size: 13px;
      }

      /* Route label styling */
      .route-label-marker {
        background: transparent !important;
        border: none !important;
      }

      .route-label-text {
        background: rgba(255, 255, 255, 0.9);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 700;
        border: 1px solid;
        white-space: nowrap;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div id="sidebar">
        <div class="section">
          <div class="section-title">Route Optimization</div>

          <div class="mode-tabs">
            <div class="mode-tab active" data-mode="map">Map Click</div>
            <div class="mode-tab" data-mode="manual">Lat/Lng</div>
          </div>

          <div id="map-mode" class="input-mode">
            <div class="input-group">
              <label>Start Location</label>
              <input
                type="text"
                id="start-display"
                readonly
                placeholder="Click on map to set start point"
              />
            </div>
            <div class="input-group">
              <label>End Location</label>
              <input
                type="text"
                id="end-display"
                readonly
                placeholder="Click on map to set end point"
              />
            </div>
          </div>

          <div id="manual-mode" class="input-mode" style="display: none">
            <div class="input-group">
              <label>Start Location</label>
              <div class="location-input">
                <input
                  type="number"
                  id="start-lat-manual"
                  placeholder="Latitude"
                  step="0.0001"
                />
                <input
                  type="number"
                  id="start-lng-manual"
                  placeholder="Longitude"
                  step="0.0001"
                />
              </div>
            </div>
            <div class="input-group">
              <label>End Location</label>
              <div class="location-input">
                <input
                  type="number"
                  id="end-lat-manual"
                  placeholder="Latitude"
                  step="0.0001"
                />
                <input
                  type="number"
                  id="end-lng-manual"
                  placeholder="Longitude"
                  step="0.0001"
                />
              </div>
            </div>
          </div>

          <div class="input-group">
            <label>Start Time</label>
            <input type="datetime-local" id="start-time" />
          </div>

          <div class="input-group">
            <label>End Time</label>
            <input type="datetime-local" id="end-time" />
          </div>

          <div class="input-group">
            <label>Simulations</label>
            <select id="simulations">
              <option value="100">100 (Fast)</option>
              <option value="500" selected>500 (Recommended)</option>
              <option value="1000">1000 (Thorough)</option>
            </select>
          </div>

          <button class="btn btn-primary" id="optimize-btn">
            Find Best Routes
          </button>
          <button class="btn btn-secondary" id="clear-btn">Clear All</button>

          <div id="error-container"></div>
        </div>

        <div class="results-section" id="results-section">
          <div class="section">
            <div class="section-title">Recommended Routes</div>
            <div id="results-container">
              <div class="no-results">
                Set locations and click "Find Best Routes" to see
                recommendations
              </div>
            </div>
          </div>
        </div>
      </div>

      <div id="map-container">
        <div id="map"></div>
        <div class="marker-instructions" id="marker-instructions">
          Click on map to set <strong id="marker-type">start</strong> point
        </div>
        <div class="loading-overlay" id="loading-overlay">
          <div class="loading-content">
            <div class="spinner"></div>
            <div class="loading-text" id="loading-text">
              Optimizing routes...
            </div>
            <div class="loading-progress" id="loading-progress">
              Starting simulation...
            </div>
            <div class="progress-bar-container">
              <div
                class="progress-bar"
                id="progress-bar"
                style="width: 0%"
              ></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const map = L.map("map").setView([13.7563, 100.5018], 12);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 19,
        attribution: "&copy; OpenStreetMap contributors",
      }).addTo(map);

      let startMarker = null;
      let endMarker = null;
      let routeLayers = [];
      let currentMode = "map";
      let settingMarker = null;
      let optimizationResults = null;

      const startIcon = L.icon({
        iconUrl:
          "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAyNCAzNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMEMxOC42MjcgMCAyNCA1LjM3MyAyNCAxMmMwIDkuNjI3LTEyIDI0LTEyIDI0UzAgMjEuNjI3IDAgMTJDMCA1LjM3MyA1LjM3MyAwIDEyIDB6IiBmaWxsPSIjMjhhNzQ1Ii8+PHRleHQgeD0iMTIiIHk9IjE2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+UzwvdGV4dD48L3N2Zz4=",
        iconSize: [24, 36],
        iconAnchor: [12, 36],
      });

      const endIcon = L.icon({
        iconUrl:
          "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMzYiIHZpZXdCb3g9IjAgMCAyNCAzNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMEMxOC42MjcgMCAyNCA1LjM3MyAyNCAxMmMwIDkuNjI3LTEyIDI0LTEyIDI0UzAgMjEuNjI3IDAgMTJDMCA1LjM3MyA1LjM3MyAwIDEyIDB6IiBmaWxsPSIjZGMzNTQ1Ii8+PHRleHQgeD0iMTIiIHk9IjE2IiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IndoaXRlIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXdlaWdodD0iYm9sZCI+RTwvdGV4dD48L3N2Zz4=",
        iconSize: [24, 36],
        iconAnchor: [12, 36],
      });

      // Mode switching
      document.querySelectorAll(".mode-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          currentMode = tab.dataset.mode;
          document
            .querySelectorAll(".mode-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");

          document
            .querySelectorAll(".input-mode")
            .forEach((m) => (m.style.display = "none"));
          document.getElementById(`${currentMode}-mode`).style.display =
            "block";

          if (currentMode === "map") {
            enableMapClicking();
          } else {
            disableMapClicking();
          }
        });
      });

      function enableMapClicking() {
        if (!startMarker) {
          settingMarker = "start";
          document
            .getElementById("marker-instructions")
            .classList.add("active");
          document.getElementById("marker-type").textContent = "start";
        } else if (!endMarker) {
          settingMarker = "end";
          document
            .getElementById("marker-instructions")
            .classList.add("active");
          document.getElementById("marker-type").textContent = "end";
        }
      }

      function disableMapClicking() {
        settingMarker = null;
        document
          .getElementById("marker-instructions")
          .classList.remove("active");
      }

      map.on("click", (e) => {
        if (currentMode !== "map" || !settingMarker) return;

        const lat = e.latlng.lat.toFixed(4);
        const lng = e.latlng.lng.toFixed(4);

        if (settingMarker === "start") {
          if (startMarker) map.removeLayer(startMarker);
          startMarker = L.marker([lat, lng], { icon: startIcon }).addTo(map);
          document.getElementById("start-display").value = `${lat}, ${lng}`;
          settingMarker = "end";
          document.getElementById("marker-type").textContent = "end";
        } else if (settingMarker === "end") {
          if (endMarker) map.removeLayer(endMarker);
          endMarker = L.marker([lat, lng], { icon: endIcon }).addTo(map);
          document.getElementById("end-display").value = `${lat}, ${lng}`;
          settingMarker = null;
          document
            .getElementById("marker-instructions")
            .classList.remove("active");
        }
      });

      // Initialize time inputs
      function roundTo5min(d) {
        const ms = 5 * 60 * 1000;
        return new Date(Math.floor(d.getTime() / ms) * ms);
      }

      const now = roundTo5min(new Date());
      const endTime = new Date(now.getTime() + 8 * 60 * 60 * 1000);

      const pad = (n) => n.toString().padStart(2, "0");
      const formatLocal = (d) =>
        `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}T${pad(
          d.getHours()
        )}:${pad(d.getMinutes())}`;

      document.getElementById("start-time").value = formatLocal(now);
      document.getElementById("end-time").value = formatLocal(endTime);

      // Optimize button with loading animation
      document
        .getElementById("optimize-btn")
        .addEventListener("click", async () => {
          const errorContainer = document.getElementById("error-container");
          errorContainer.innerHTML = "";

          let startLat, startLng, endLat, endLng;

          if (currentMode === "map") {
            if (!startMarker || !endMarker) {
              showError("Please set both start and end points on the map");
              return;
            }
            startLat = startMarker.getLatLng().lat;
            startLng = startMarker.getLatLng().lng;
            endLat = endMarker.getLatLng().lat;
            endLng = endMarker.getLatLng().lng;
          } else if (currentMode === "manual") {
            startLat = parseFloat(
              document.getElementById("start-lat-manual").value
            );
            startLng = parseFloat(
              document.getElementById("start-lng-manual").value
            );
            endLat = parseFloat(
              document.getElementById("end-lat-manual").value
            );
            endLng = parseFloat(
              document.getElementById("end-lng-manual").value
            );

            if (
              isNaN(startLat) ||
              isNaN(startLng) ||
              isNaN(endLat) ||
              isNaN(endLng)
            ) {
              showError("Please enter valid coordinates");
              return;
            }
          }

          const startTime = document.getElementById("start-time").value;
          const endTime = document.getElementById("end-time").value;
          const nSimulations = parseInt(
            document.getElementById("simulations").value
          );

          if (!startTime || !endTime) {
            showError("Please select start and end times");
            return;
          }

          // Show loading overlay
          showLoading("Running Monte Carlo simulations...", 0);
          document.getElementById("optimize-btn").disabled = true;

          try {
            // Simulate progress during optimization
            const progressInterval = setInterval(() => {
              const currentProgress = parseInt(
                document.getElementById("progress-bar").style.width
              );
              if (currentProgress < 90) {
                updateProgress(currentProgress + 10, "Optimizing routes...");
              }
            }, 500);

            const res = await fetch("/api/optimize_route", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                start_lat: startLat,
                start_lng: startLng,
                end_lat: endLat,
                end_lng: endLng,
                start_time: startTime,
                end_time: endTime,
                n_simulations: nSimulations,
              }),
            });

            clearInterval(progressInterval);
            updateProgress(100, "Optimization complete!");

            const data = await res.json();

            if (!res.ok) {
              throw new Error(data.error || "Optimization failed");
            }

            optimizationResults = data;

            // Small delay to show 100% completion
            await new Promise((resolve) => setTimeout(resolve, 500));

            displayResults(data.routes);
            hideLoading();
          } catch (e) {
            hideLoading();
            showError(e.message);
          } finally {
            document.getElementById("optimize-btn").disabled = false;
          }
        });

      function showLoading(text, progress) {
        document.getElementById("loading-overlay").classList.add("active");
        document.getElementById("loading-text").textContent = text;
        document.getElementById("progress-bar").style.width = progress + "%";
      }

      function updateProgress(percent, text) {
        document.getElementById("progress-bar").style.width = percent + "%";
        document.getElementById("loading-progress").textContent = text;
      }

      function hideLoading() {
        document.getElementById("loading-overlay").classList.remove("active");
      }

      function showError(message) {
        const errorContainer = document.getElementById("error-container");
        errorContainer.innerHTML = `<div class="error-message">${message}</div>`;
      }

      function displayResults(routes) {
        const container = document.getElementById("results-container");
        const colors = ["#28a745", "#007bff", "#ff6600"];

        container.innerHTML = routes
          .map(
            (route, i) => `
          <div class="route-card" data-route-index="${i}">
            <div class="route-header">
              <div class="route-rank">#${i + 1}</div>
              <div class="route-revenue">${route.total_revenue.toFixed(
                0
              )} THB</div>
            </div>

            <div class="route-stats">
              <div class="stat">
                <span class="stat-label">Trips</span>
                <span class="stat-value">${route.total_trips}</span>
              </div>
              <div class="stat">
                <span class="stat-label">Distance</span>
                <span class="stat-value">${route.total_distance_km.toFixed(
                  1
                )} km</span>
              </div>
              <div class="stat">
                <span class="stat-label">Trip Time</span>
                <span class="stat-value">${route.total_trip_time_minutes.toFixed(
                  0
                )} min</span>
              </div>
              <div class="stat">
                <span class="stat-label">Idle Time</span>
                <span class="stat-value">${route.total_idle_time_minutes.toFixed(
                  0
                )} min</span>
              </div>
            </div>

            <div class="stat">
              <span class="stat-label">Arrival Time</span>
              <span class="stat-value">${new Date(
                route.arrival_time
              ).toLocaleTimeString("en-US", {
                hour: "2-digit",
                minute: "2-digit",
              })}</span>
            </div>

            <div class="route-color-bar" style="background: ${colors[i]}"></div>

            <div class="trip-list">
              ${route.trips
                .map(
                  (trip) => `
                <div class="trip-item">
                  <strong>Trip ${trip.trip_number}</strong>: ${
                    trip.pickup_time
                  } - ${trip.dropoff_time}<br>
                  ${trip.fare_thb.toFixed(0)} THB | ${trip.distance_km.toFixed(
                    1
                  )} km | ${trip.duration_minutes.toFixed(0)} min
                </div>
              `
                )
                .join("")}
            </div>
          </div>
        `
          )
          .join("");

        document.querySelectorAll(".route-card").forEach((card) => {
          card.addEventListener("click", async (e) => {
            const routeIndex = parseInt(card.dataset.routeIndex);

            document
              .querySelectorAll(".route-card")
              .forEach((c) => c.classList.remove("active", "expanded"));
            card.classList.add("active", "expanded");

            await displayRouteOnMap(
              optimizationResults.routes[routeIndex],
              routeIndex
            );
          });
        });

        if (routes.length > 0) {
          document.querySelector(".route-card").click();
        }
      }

      async function displayRouteOnMap(route, routeIndex) {
        routeLayers.forEach((layer) => map.removeLayer(layer));
        routeLayers = [];

        const totalTrips = route.trips.length;

        showLoading(`Loading route #${routeIndex + 1}...`, 0);

        try {
          updateProgress(20, "Fetching route data...");

          const res = await fetch(`/api/route_geojson/${routeIndex}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              route: route,
              start_location: optimizationResults.parameters.start_location,
              end_location: optimizationResults.parameters.end_location,
            }),
          });

          updateProgress(50, "Processing road routes...");

          const geojson = await res.json();

          updateProgress(80, "Rendering map...");

          const layer = L.geoJSON(geojson, {
            style: (feature) => ({
              color: feature.properties.color,
              weight: 3,
              opacity: 0.8,
            }),
            pointToLayer: (feature, latlng) => {
              const props = feature.properties;

              // Route label marker (Option D)
              if (props.type === "route_label") {
                const labelHtml = `<div class="route-label-text" style="color: ${props.color}; border-color: ${props.color};">Trip ${props.trip_number}</div>`;

                return L.marker(latlng, {
                  icon: L.divIcon({
                    html: labelHtml,
                    className: "route-label-marker",
                    iconSize: [50, 20],
                    iconAnchor: [20, 10],
                  }),
                });
              }

              // Pickup/dropoff markers with offset (Option A)
              let iconHtml = "";

              if (props.type === "pickup") {
                iconHtml = `<div style="background: ${props.color}; color: white; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 13px;">${props.trip_number}</div>`;
              } else {
                iconHtml = `<div style="background: white; color: ${props.color}; border-radius: 50%; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; font-weight: bold; border: 2px solid ${props.color}; box-shadow: 0 2px 4px rgba(0,0,0,0.3); font-size: 13px;">${props.trip_number}</div>`;
              }

              return L.marker(latlng, {
                icon: L.divIcon({
                  html: iconHtml,
                  className: "",
                  iconSize: [28, 28],
                  iconAnchor: [14, 14],
                }),
              });
            },
            onEachFeature: (feature, layer) => {
              const props = feature.properties;

              if (props.type === "pickup") {
                let popupContent = `<b>Trip ${props.trip_number} Pickup</b><br>Time: ${props.time}`;
                if (props.is_shared) {
                  popupContent += `<br><span style="color: #ff6600; font-weight: bold;">üìç Shared zone with trips: ${props.shared_trips.join(
                    ", "
                  )}</span>`;
                }
                layer.bindPopup(popupContent);
              } else if (props.type === "dropoff") {
                let popupContent = `<b>Trip ${
                  props.trip_number
                } Dropoff</b><br>Time: ${
                  props.time
                }<br>Fare: ${props.fare_thb.toFixed(0)} THB`;
                if (props.is_shared) {
                  popupContent += `<br><span style="color: #ff6600; font-weight: bold;">üìç Shared zone with trips: ${props.shared_trips.join(
                    ", "
                  )}</span>`;
                }
                layer.bindPopup(popupContent);
              } else if (props.trip_number && !props.type) {
                layer.bindPopup(
                  `<b>Trip ${
                    props.trip_number
                  }</b><br>${props.distance_km.toFixed(
                    1
                  )} km | ${props.duration_minutes.toFixed(
                    0
                  )} min<br>${props.fare_thb.toFixed(0)} THB`
                );
              }
            },
          }).addTo(map);

          routeLayers.push(layer);

          const bounds = layer.getBounds();
          if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [50, 50] });
          }

          updateProgress(
            100,
            `Route #${routeIndex + 1} loaded - All ${totalTrips} trips visible!`
          );

          setTimeout(hideLoading, 800);
        } catch (e) {
          hideLoading();
          console.error("Failed to display route:", e);
          showError("Failed to display route on map");
        }
      }

      document.getElementById("clear-btn").addEventListener("click", () => {
        if (startMarker) map.removeLayer(startMarker);
        if (endMarker) map.removeLayer(endMarker);
        startMarker = null;
        endMarker = null;

        routeLayers.forEach((layer) => map.removeLayer(layer));
        routeLayers = [];

        document.getElementById("start-display").value = "";
        document.getElementById("end-display").value = "";
        document.getElementById("start-lat-manual").value = "";
        document.getElementById("start-lng-manual").value = "";
        document.getElementById("end-lat-manual").value = "";
        document.getElementById("end-lng-manual").value = "";

        document.getElementById("results-container").innerHTML =
          '<div class="no-results">Set locations and click "Find Best Routes" to see recommendations</div>';
        document.getElementById("error-container").innerHTML = "";

        optimizationResults = null;

        if (currentMode === "map") {
          enableMapClicking();
        }
      });
    </script>
  </body>
</html>
